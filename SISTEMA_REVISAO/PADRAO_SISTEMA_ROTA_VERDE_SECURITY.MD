# Padr√£o de Seguran√ßa do Sistema Rota Verde
**Vers√£o:** 1.2.0
**Status:** Ativo

Este documento define os padr√µes de seguran√ßa obrigat√≥rios para o desenvolvimento e manuten√ß√£o do sistema Rota Verde.

---

## 1. Princ√≠pios Fundamentais
1.  **Negue por Padr√£o:** Todo acesso √© bloqueado a menos que explicitamente permitido.
2.  **Defesa em Profundidade:** M√∫ltiplas camadas de prote√ß√£o (Frontend, Gateway, Controller, Banco).
3.  **Privil√©gio M√≠nimo:** Usu√°rios e servi√ßos t√™m apenas as permiss√µes essenciais.

---

## 2. Autentica√ß√£o e Sess√£o
- **JWT:** Uso obrigat√≥rio de `Authorization: Bearer <token>`.
- **Validade:** Token de acesso curto (ex: 2h) e Refresh Token rotativo (14 dias).
- **Bloqueio:** Usu√°rios com `isActive: false` devem ser bloqueados imediatamente, inclusive se o token ainda for v√°lido (verificado via middleware).
- **Anti-Automa√ß√£o:** Rate limit rigoroso no login (5 req/min ou similar) e Idempotency Key em POSTs cr√≠ticos.

> **üìå Nota Arquitetural (isActive Check):**
> O check de `isActive` ocorre em TODA requisi√ß√£o autenticada via `authMiddleware`.
> Impacto de performance aceit√°vel (consulta simples por PK, ~1-5ms).
> Pode ser otimizado com cache curto (ex: 60s em Redis) no futuro se necess√°rio.

---

## 3. Controle de Acesso (Authorization)
- **RBAC:** Uso estrito de Roles (`admin`, `driver`, `supervisor`).
- **Ownership:** Usu√°rios s√≥ podem acessar/modificar recursos que lhes pertencem (`driverId` deve vir do Token, nunca do Body).
- **Prote√ß√£o de Dados:**
    - Lista de Motoristas: Apenas Admin.
    - Detalhes Financeiros: Apenas Dono ou Admin.

> **üìå Nota sobre Ownership Middleware:**
> O middleware `requireShiftOwner` N√ÉO substitui a valida√ß√£o de exist√™ncia do recurso.
> Controllers que dependem de ownership DEVEM validar a presen√ßa e exist√™ncia do recurso obrigatoriamente.

---

## 4. Prote√ß√£o de Dados e Privacidade
- **Senhas:** Hashing com Bcrypt (m√≠nimo 10 rounds).
- **Logs:**
    - **Obrigat√≥rio:** Logar `userId`, `IP`, `action`, `payloadHash` de opera√ß√µes financeiras.
    - **payloadHash:** `sha256(body)` para rastreabilidade sem expor PII.
    - **Proibido:** Logar senhas, tokens ou body completo com dados sens√≠veis.
- **Payload:**
    - Limite global: `10kb` para opera√ß√µes normais.
    - Exce√ß√£o: `50mb` **somente** em rotas admin de restore, **com** `requireAdmin` + rate-limit espec√≠fico + timeout de request.

---

## 5. Desenvolvimento Seguro
- **Transa√ß√µes:** Todas as opera√ß√µes que afetam mais de uma tabela (ex: finalizar turno + atualizar ve√≠culo) devem ser at√¥micas.
- **Valida√ß√£o:** Zod schemas para TODAS as entradas.
    - **Dinheiro:** `.min(0.01)` ‚Äî zero n√£o √© permitido em valores monet√°rios.
    - **Kilometragem:** `.min(0)` ‚Äî zero √© permitido.
- **SQL Injection:** Proibido concatena√ß√£o de strings em queries. Uso obrigat√≥rio de ORM (Drizzle) ou Prepared Statements.

---

## 6. Auditoria
- O sistema deve manter um rastro de auditoria (`auditLogger`) para todas as opera√ß√µes de escrita (`POST`, `PUT`, `DELETE`) em m√≥dulos cr√≠ticos.
- **A√ß√µes Sem√¢nticas:** Usar nomes de a√ß√£o claros como `CREATE_EXPENSE`, `FINISH_SHIFT`, `DELETE_RIDE`.

---

## 7. Anti-Replay (Idempot√™ncia)
POSTs cr√≠ticos devem usar o middleware `preventReplay` para bloquear requisi√ß√µes duplicadas em janela de 5 minutos.

**Endpoints obrigat√≥rios:**
- `POST /financial/expenses`
- `POST /rides`
- `POST /shifts/start` (via `/shifts` POST)
- `POST /shifts/:id/finish`

> **‚ö†Ô∏è Nota de Produ√ß√£o:**
> A implementa√ß√£o atual usa Map em mem√≥ria e N√ÉO √© adequada para:
> - M√∫ltiplas inst√¢ncias (horizontal scaling)
> - Ambientes com restart frequente
>
> Para produ√ß√£o multi-instance, substituir por Redis ou store compartilhado.

---

## 8. Checklist de Deploy (Security Gate)
Antes de qualquer subida para produ√ß√£o:
- [ ] Rodar `tools/security-gate.ps1` e garantir exit 0.
- [ ] Verificar se novas rotas t√™m `requireAuth` e `permission check`.
- [ ] Confirmar se migra√ß√µes de banco n√£o exp√µem dados.
- [ ] Validar que opera√ß√µes financeiras possuem `auditLog`.
- [ ] Verificar ownership em rotas que manipulam recursos de usu√°rio.

---
**Documento mantido pelo time de Seguran√ßa / AI Agent.**
**√öltima atualiza√ß√£o:** 31/12/2025
